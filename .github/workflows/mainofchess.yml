name: Chess Engine CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: List files (debug)
      run: ls -R

    - name: Install compiler
      run: sudo apt-get update && sudo apt-get install -y g++

    - name: Build my engine
      run: g++ -std=c++17 -O2 main.cpp -o mychessengine

  match:
    name: Engine vs Stockfish
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Install compiler and tools
      run: |
        sudo apt-get update
        sudo apt-get install -y g++ stockfish wget unzip

    - name: Build my engine
      run: g++ -std=c++17 -O2 main.cpp -o mychessengine

    - name: Download cutechess-cli
      run: |
        wget -O cutechess.zip https://github.com/cutechess/cutechess/releases/download/1.2.0/cutechess-1.2.0-linux.zip
        unzip cutechess.zip -d cutechess
        chmod +x cutechess/cutechess-cli

    - name: Debug binaries
      run: |
        ls -R
        which stockfish || true
        stockfish -version || true
        ./mychessengine || true
        ./cutechess/cutechess-cli --version || true

    - name: Run match (10 games, 5+0)
      run: |
        ./cutechess/cutechess-cli \
          -engine cmd=./mychessengine name=MyEngine \
          -engine cmd=$(which stockfish) name=Stockfish \
          -each proto=uci tc=5+0 \
          -games 10 \
          -repeat \
          -recover \
          -draw movenumber=60 movecount=4 score=5 \
          -pgnout match.pgn \
          -current

    - name: Upload PGN results
      uses: actions/upload-artifact@v4
      with:
        name: match-results
        path: match.pgn

  release:
    name: Release binaries
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout source
      uses: actions/checkout@v3

    - name: Build Linux binary
      run: g++ -std=c++17 -O2 main.cpp -o mychessengine-linux

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: mychessengine-linux
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
